
#include <coopy/PolyBook.h>
#include <coopy/ShortTextBook.h>

#include <fstream>

using namespace std;
using namespace coopy::store;

#cmakedefine USE_NONE

#ifndef USE_NONE
#cmakedefine USE_GNUMERIC
#cmakedefine USE_REMOTE_SQL
#endif

#ifdef USE_GNUMERIC
#include <coopy/GnumericTextBookFactory.h>
#endif

#include <json/json.h>

#ifdef USE_REMOTE_SQL
#include <coopy/RemoteSqlTextBook.h>
#endif

TextBook *readHelper(const char *fname,
		     const char *ext,
		     const char *data) {
  dbg_printf("Trying plugin data formats...\n");
  TextBook *result = NULL;
  if (string(ext)==".json") {
    dbg_printf("Trying with JSON...\n");
    ifstream in(fname);
    Json::Value root;
    Json::Reader reader;
    if (!reader.parse(in,root,false)) {
      fprintf(stderr,"Failed to parse %s\n", fname);
      return NULL;
    }
    Property p;
    for (Json::Value::iterator it=root.begin(); it!=root.end(); it++) {
      //printf("Got %s -> %s\n", it.memberName(),
      //(*it).asCString());
      p.put(it.memberName(),(*it).asCString());
    }
    DataBook *book = NULL;
    string key = p.get("type",PolyValue::makeString("none")).asString();
    if (key=="mysql") {
#ifdef USE_REMOTE_SQL
      book = new RemoteSqlTextBook();
#endif
    } else if (key=="csv") {
      book = new ShortTextBook();
    }
    if (book!=NULL) {
      if (!book->open(p)) {
	fprintf(stderr,"Failed to read data source\n");
	delete book;
      } else {
	result = book;
      }
    }  
  }
#ifdef USE_GNUMERIC
  dbg_printf("Trying with Gnumeric...\n");
  GnumericTextBookFactory fact;
  if (fact.check(fname,ext,data)) {
    result = fact.load(fname);
  }
  if (result!=NULL) {
    dbg_printf("Got a Gnumeric-readable file\n");
    return result;
  } else {
    dbg_printf("Not a Gnumeric-readable file\n");
  }
#endif
  return result;
}

